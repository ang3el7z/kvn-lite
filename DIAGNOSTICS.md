# Диагностика проблем с ботом

## Проблема
После установки на сервере бот не отвечает на первое сообщение, хотя должен сделать пользователя админом и ответить.

## Что было исправлено

### 1. Исправлен баг в методе `request()`
   - Была неправильная проверка ошибок API Telegram
   - Теперь ошибки правильно логируются в `/logs/requests_error`

### 2. Добавлено логирование в метод `auth()`
   - Все попытки авторизации логируются в `/logs/auth_debug`
   - Логируется создание первого админа
   - Логируются ошибки при работе с `config.php`

### 3. Добавлена обработка ошибок в `index.php`
   - Глобальная обработка PHP ошибок
   - Автоматическое создание `config.php` если его нет
   - Логирование всех входящих запросов в `/logs/bot_input`

## Как проверить что не так

### На сервере выполните:

```bash
# 1. Запустите скрипт диагностики
./scripts/check_bot_status.sh

# 2. Проверьте логи вручную
tail -f /logs/php_error        # Ошибки PHP
tail -f /logs/auth_debug       # Проблемы с авторизацией
tail -f /logs/requests_error   # Ошибки API Telegram
tail -f /logs/bot_input        # Входящие запросы от Telegram
```

### Основные места для проверки:

1. **Файл `app/config.php` должен существовать**
   ```bash
   ls -la app/config.php
   cat app/config.php
   ```
   Должен содержать минимум:
   ```php
   <?php
   
   $c = ['key' => 'YOUR_BOT_TOKEN'];
   ```

2. **Проверьте webhook**
   - Webhook должен быть настроен на: `https://YOUR_IP/tlgrm?k=BOT_TOKEN`
   - Проверить можно через API: `https://api.telegram.org/botTOKEN/getWebhookInfo`

3. **Проверьте права доступа**
   ```bash
   # app/config.php должен быть доступен для записи
   chmod 666 app/config.php
   
   # Директория /logs должна существовать и быть доступна для записи
   mkdir -p /logs
   chmod 777 /logs
   ```

4. **Проверьте что PHP обрабатывает запросы**
   ```bash
   # Проверьте логи веб-сервера (nginx/apache)
   tail -f /var/log/nginx/error.log
   # или
   tail -f /var/log/apache2/error.log
   ```

## Типичные проблемы и решения

### Проблема: `config.php` не существует
**Решение:** Создайте файл вручную:
```bash
echo "<?php\n\n\$c = ['key' => 'YOUR_BOT_TOKEN'];" > app/config.php
```

### Проблема: Бот не получает webhook
**Решение:** 
1. Проверьте что webhook настроен: запустите `php app/init.php`
2. Проверьте что URL доступен извне (firewall, порты)
3. Проверьте SSL сертификат (webhook требует HTTPS)

### Проблема: Ошибки в логах `/logs/requests_error`
**Решение:**
- Проверьте что токен бота правильный
- Проверьте что бот не заблокирован
- Проверьте интернет соединение сервера

### Проблема: Пользователь не становится админом
**Решение:**
1. Проверьте логи `/logs/auth_debug` - там должно быть сообщение о создании админа
2. Проверьте что `app/config.php` доступен для записи
3. Проверьте содержимое `config.php` после отправки сообщения

## После исправлений

После применения исправлений:

1. **Перезапустите веб-сервер/PHP-FPM**
   ```bash
   # Для systemd
   systemctl restart php-fpm
   systemctl restart nginx
   
   # Или для Docker
   docker-compose restart
   ```

2. **Отправьте боту сообщение `/start` или `/menu`**

3. **Проверьте логи:**
   ```bash
   tail -20 /logs/auth_debug
   tail -20 /logs/bot_input
   ```

4. **Проверьте что вы стали админом:**
   ```bash
   cat app/config.php | grep admin
   ```

## Дополнительная отладка

Если проблема не решена, включите режим отладки:

1. Отредактируйте `app/config.php`:
   ```php
   <?php
   
   $c = [
       'key' => 'YOUR_BOT_TOKEN',
       'debug' => true,  // Добавьте эту строку
   ];
   ```

2. Перезапустите сервер

3. Проверьте `/logs/requests` - там будут все запросы и ответы

