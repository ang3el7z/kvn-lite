# Инструкция по применению исправлений

## Шаг 1: Запушить изменения

```bash
git push
```

## Шаг 2: На сервере - обновить код

```bash
# Перейти в директорию проекта
cd /path/to/your/project

# Обновить код из репозитория
git pull

# Или если используете конкретную ветку:
git checkout fix-bot-server-S9rmS
git pull
```

## Шаг 3: На сервере - запустить скрипт диагностики

```bash
# Сделать скрипт исполняемым
chmod +x scripts/check_bot_status.sh

# Запустить диагностику
bash scripts/check_bot_status.sh
```

## Шаг 4: Проверить логи

```bash
# Проверить основные логи
tail -50 /logs/php_error        # Ошибки PHP
tail -50 /logs/auth_debug       # Авторизация (новый лог!)
tail -50 /logs/requests_error   # Ошибки API Telegram
tail -50 /logs/bot_input        # Входящие запросы (новый лог!)
```

## Шаг 5: Перезапустить сервер

```bash
# Если используете systemd
systemctl restart php-fpm
systemctl restart nginx

# Или если используете Docker
docker-compose restart

# Или если используете Unit (как в проекте)
# Перезапустите контейнер PHP
```

## Шаг 6: Протестировать бота

1. Отправьте боту сообщение `/start` или `/menu`
2. Проверьте логи:
   ```bash
   tail -20 /logs/auth_debug
   ```
   Должно появиться сообщение "Creating first admin: YOUR_USER_ID"
3. Проверьте что вы стали админом:
   ```bash
   cat app/config.php | grep admin
   ```

## Что делать если проблема не решена

1. **Проверьте все логи:**
   ```bash
   # Соберите все логи в один файл для анализа
   echo "=== php_error ===" > /tmp/all_logs.txt
   tail -100 /logs/php_error >> /tmp/all_logs.txt
   echo "=== auth_debug ===" >> /tmp/all_logs.txt
   tail -100 /logs/auth_debug >> /tmp/all_logs.txt
   echo "=== requests_error ===" >> /tmp/all_logs.txt
   tail -100 /logs/requests_error >> /tmp/all_logs.txt
   echo "=== bot_input ===" >> /tmp/all_logs.txt
   tail -100 /logs/bot_input >> /tmp/all_logs.txt
   
   # Посмотрите результат
   cat /tmp/all_logs.txt
   ```

2. **Проверьте webhook:**
   ```bash
   # Замените YOUR_TOKEN на токен вашего бота
   curl "https://api.telegram.org/botYOUR_TOKEN/getWebhookInfo"
   ```

3. **Проверьте что config.php доступен для записи:**
   ```bash
   ls -la app/config.php
   chmod 666 app/config.php  # Если нужно
   ```

4. **Проверьте что директория /logs существует:**
   ```bash
   ls -la /logs
   mkdir -p /logs  # Если не существует
   chmod 777 /logs  # Если нужно
   ```

## Быстрая проверка

После применения изменений выполните:

```bash
# 1. Проверка статуса
bash scripts/check_bot_status.sh

# 2. Отправьте боту /start

# 3. Проверьте логи
tail -20 /logs/auth_debug

# 4. Проверьте config.php
cat app/config.php
```

Если в `/logs/auth_debug` появилась запись о создании админа, а в `config.php` появился ваш ID в массиве `admin` - значит всё работает!

